# Mobile App Build Guide

## Building APK with Docker

### Quick Start

Build the Android APK using Docker:

```bash
# From project root
docker compose run --rm mobile-builder
```

The generated APK will be available at:
```
apps/mobile/artifacts/app-release.apk
```

### What happens during the build

1. **Git initialization**: Initializes a temporary git repo to satisfy Expo requirements
2. **Install dependencies**: npm packages are installed with `--legacy-peer-deps`
3. **Clean Android build directories**: Removes previous build artifacts
4. **Expo prebuild**: Generates native Android project in CI mode
5. **Patch gradle.properties**: Applies Docker-specific optimizations (see below)
6. **Generate local.properties**: Sets Android SDK location
7. **Gradle build**: Compiles and packages the APK
8. **APK output**: Copies the APK to `artifacts/` directory

### Docker-Specific Gradle Optimizations

Since the `android/` folder is git-ignored and regenerated by `expo prebuild`, the build script automatically patches `gradle.properties` with Docker-optimized settings:

- **Memory allocation**: Increased to 4GB (`-Xmx4096m`) to prevent daemon crashes
- **Parallel execution**: Disabled (`org.gradle.parallel=false`) for stability
- **File system watching**: Disabled (`org.gradle.vfs.watch=false`) to fix polling errors
- **Architecture**: Only `arm64-v8a` (covers 95%+ modern devices, faster builds)

This is done by `scripts/patch-gradle-properties.sh` which runs automatically after `expo prebuild`.

### Build Environment

The Docker container includes:
- **Platform**: linux/amd64 (x86_64) - Required for Android SDK tools
- **Node.js**: 20.x
- **Java**: OpenJDK 17
- **Android SDK**: API Level 36
- **Build Tools**: 35.0.0
- **NDK**: 26.1.10909125

**Note for Apple Silicon (M1/M2/M3) users**: The container runs in x86_64 emulation mode because Android SDK tools are not available for ARM architecture. This is handled automatically by Docker/OrbStack.

### Docker Volumes

The build uses persistent volumes for faster subsequent builds:
- `mobile_node_modules`: npm packages cache
- `mobile_gradle_cache`: Gradle dependencies cache
- `mobile_android_cache`: Android build cache

### Troubleshooting

#### Clean build
If you encounter build issues, clean the Docker volumes:

```bash
docker compose down -v
docker compose run --rm mobile-builder
```

#### View build logs
The build script provides detailed output. If the build fails, check:
- Node.js dependency installation
- Expo prebuild output
- Gradle error messages

#### Manual build steps
To run individual steps manually:

```bash
# Start a shell in the container
docker compose run --rm mobile-builder bash

# Then run commands manually:
npm install --legacy-peer-deps
npx expo prebuild --platform android --clean
cd android
./gradlew assembleRelease
```

### Building Debug APK

To build a debug APK instead, modify `scripts/docker-build.sh`:
- Uncomment the debug build lines at the end of the script
- Or manually run: `./gradlew assembleDebug`

### Local Build (without Docker)

Requirements:
- Node.js 20.x
- Java 17
- Android SDK with API 36 and Build Tools 35.0.0

Commands:
```bash
cd apps/mobile
npm install
npx expo prebuild --platform android
cd android
./gradlew assembleRelease
```

The APK will be at: `android/app/build/outputs/apk/release/app-release.apk`

**Note**: Local builds use the default `gradle.properties` generated by Expo. The Docker-specific patches are only applied in the containerized build and don't affect local development.
