name: CI

on:
  pull_request:
    branches: ["**"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Optional but helps with docker layer caching and consistent builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for CI
        run: |
          cat > .env << EOF
          # CI Environment Variables
          ENCRYPTION_KEY=test-encryption-key-for-ci-only-not-secure
          JWT_SECRET_KEY=test-jwt-secret-key-for-ci-only
          JWT_ALGORITHM=HS256
          JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
          DATABASE_URL=postgresql+psycopg://area:area@db:5432/area
          EMAIL_SENDER=ci-test@action-reaction.local
          SMTP_HOST=localhost
          SMTP_PORT=1025
          SMTP_USE_TLS=false
          EMAIL_CONFIRMATION_BASE_URL=http://localhost:8080/api/v1/auth/confirm
          EMAIL_CONFIRMATION_SUCCESS_REDIRECT_URL=http://localhost:3000/confirm/success
          EMAIL_CONFIRMATION_FAILURE_REDIRECT_URL=http://localhost:3000/confirm/error
          OAUTH_REDIRECT_BASE_URL=http://localhost:8080/api/v1/oauth
          FRONTEND_REDIRECT_URL_WEB=http://localhost:3000
          FRONTEND_REDIRECT_URL_MOBILE=areamobile://oauth/callback
          GOOGLE_CLIENT_ID=dummy-client-id
          GOOGLE_CLIENT_SECRET=dummy-client-secret
          GITHUB_CLIENT_ID=dummy-github-client-id
          GITHUB_CLIENT_SECRET=dummy-github-client-secret
          DISCORD_CLIENT_ID="1234567890"
          DISCORD_CLIENT_SECRET="1234567890AZERTY"
          DISCORD_BOT_TOKEN="1234567890AZERTY"
          EOF

      - name: Build images
        run: make build

      - name: Start services (docker compose up without mobile)
        run: make dev

      - name: Run tests
        run: make test

      - name: Tear down services (always)
        if: always()
        run: make down
